<!DOCTYPE html>
<html>
  <head>
    <script src="rby/midi.js"></script>
    <script src="gsc/midi.js"></script>
    <script>

      var sscale = "10px";
      var tscale = "15px"; var double_tscale = "30px";
      var tmax = 1200;
      var smin = 0;
      var smax = 100;

      var chromatic = ['C_', 'C#', 'D_', 'D#', 'E_', 'F_', 'F#', 'G_', 'G#', 'A_', 'A#', 'B_'];
      
      var game;  // the assembly reader will be stored here
      var asm;   // the assembly code will be stored here
      var prog;  // the "midi" will be stored here

      window.onload = function() {

	  var regex1 = /game=([a-zA-Z0-9]*)&(.*)/;
	  var tmp = regex1.exec(window.location.href);

	  game = lookupGame(tmp[1]);
	  game.configure(tmp[2]);

	  setHeader();
	  makePiano();
	  loadFile();

      }

      lookupGame = function(id) {
	  return window[id];
      }

      loadFile = function() {
	  var client = new XMLHttpRequest();
	  client.open('GET', game.path);
	  client.onloadend = function() {
	      asm = client.responseText;
	      prog = game.load(asm);
	      render();
	  }
	  client.send();
      }

      setHeader = function() {
	  header = document.getElementById("header");
	  header.innerText = game.name + ' - ' + game.piece;
      }

      makePiano = function() {
	  piano = document.getElementById("piano");
	  piano.border = 1;
	  sheet = document.getElementById("sheet");
	  sheet.border = 1;
	  
	  var row = document.createElement("tr");
	  piano.appendChild(row);
	  for (var s = smin; s < smax; s++) {
              var cell = document.createElement("td");
	      var blackKey = [1,3,6,8,10].indexOf(s % 12) != -1;
	      cell.bgColor = blackKey ? "#000000" : "#FFFFFF";
	      cell.width = sscale;
	      cell.height = double_tscale;
              cell.appendChild(document.createTextNode(""));
              row.appendChild(cell);
	  };

	  for (var t = 0; t < tmax; t++) {
	      var row = document.createElement("tr");
	      sheet.appendChild(row);
	      
	      for (var s = smin; s < smax; s++) {
		  var cell = document.createElement("td");
		  var blackKey = [1,3,6,8,10].indexOf(s % 12) != -1;
		  cell.bgColor = blackKey ? "#E0E0E0" : "#FFFFFF";
		  cell.width = sscale;
		  cell.height = tscale;
		  cell.appendChild(document.createTextNode(""));
		  row.appendChild(cell);
	      };
	  };
      }

      render = function() {
	  for (var stacatto = 0; stacatto < 2; stacatto++) {
	      for (var i = 0; i < prog.chan.length; i++) {
		  var chan = prog.chan[i].boot.concat(prog.chan[i].loop);
		  var t = 0;
		  for (var j = 0; j < chan.length; j++) {
		      var [key,dt] = chan[j];
		      renderNote(key, t, dt, i);
		      t += dt;
		  }
	      }
	  }
      }

      renderNote = function(key, t, dt, chan, stacatto) {
	  // (stacatto is a rendering hack, actually)
	  
	  channelColors = ['red', 'green', 'blue', 'orange'];

	  if (key == undefined || t + dt >= tmax) {
	      return;
	  }

	  // temporary hacks
	  if (game.piece == "Route1" && chan == 2) {
	      key -= 12;
	  }
	  if (game.piece == "ChampionBattle" && chan == 2) {
	      key -= 12;
	  }
	  if (game.piece == "KantoTrainerBattle" && chan == 2) {
	      key -= 12;
	  }
	  if (game.piece == "TrainerBattle" && chan == 2) {
	      key -= 12;
	  }
	  if (game.piece == "Credits" && chan == 3) {
	      return;
	  }
	  
	  for (var i = 0; i < dt; i++) {
	      var cell = sheet.rows[t+i].cells[key-smin];
	      cell.bgColor = i == 0 ? channelColors[chan] : '#808080';
	      if (stacatto) return;
	  }
      }



    </script>

  </head>

  <body>

    <center>
      <h1 id="header"></h1>
      <table id="piano" class="fixed" style="border-collapse: collapse; border: none;">
      </table>
      <br>
      <table id="sheet" class="fixed" style="border-collapse: collapse; border: none;">
      </table>
    </center>

  </body>
</html>
